## 1. 현재 로직
- 지금 로직은 다음 그림과 같다.

![[Pasted image 20240127174520.png]]
- register - sendcode - confirmcode - isVerified = true
## 2. guard 코드 변경
- isVerified인 사용자가 아니라면 모든 요청이 거절되고, isVerified인 사용자라면 모든 요청이 허용된다.

```
if (user.accessToken !== token || !user.isVerified) {
	throw new UnauthorizedException();
}
```

## 3. sendcode, confirmcode 특별처리
- 이것마저 차단하면 인증을 못한다.
- 특별처리 해주자.

```
const request = context.switchToHttp().getRequest();
const token = this.extractTokenFromHeader(request);
const currentRoute = request.route.path; // 현재 요청 경로를 얻음

// sendcode, confirmcode 경로 특별 처리
if ((currentRoute === '/users/sendcode' || currentRoute === '/users/confirmcode') && !user.isVerified) {
  request['user'] = user;
  return true;
}
```


## 4. 구현 확인
- 기본적으로 로그인 후 profile을 보려면 unauthorized 에러 발생한다.
```
{
    "message": "Unauthorized",
    "statusCode": 401
}
```

- 인증을 마친 후
```
{
    "username": "newnyup@gmail.com",
    "sub": 3,
    "role": "MEMBER",
    "iat": 1706346895,
    "exp": 1706346955
}
```
- 다음과 같이 잘 구현된 것을 볼 수 있다.